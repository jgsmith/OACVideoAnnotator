/*
# OAC Video Annotation Tool v
# 
# The **OAC Video Annotation Tool** is a MITHGrid application providing annotation capabilities for streaming
# video embedded in a web page. 
#  
# Date: Tue Apr 17 10:15:03 2012 -0400
#  
# Educational Community License, Version 2.0
# 
# Copyright 2011 University of Maryland. Licensed under the Educational
# Community License, Version 2.0 (the "License"); you may not use this file
# except in compliance with the License. You may obtain a copy of the License at
# 
# http:#www.osedu.org/licenses/ECL-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations under
# the License.
#
# Author: Grant Dickie
*/
(function(){var a,b=Array.prototype.slice,c=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};a=MITHGrid.globalNamespace("OAC"),a.namespace("Client"),a.Client.namespace("StreamingVideo"),function(a,d,e){var f,g,h;e.Client.StreamingVideo.namespace("Controller",function(c){c.namespace("KeyboardListener",function(c){return c.initController=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initInstance.apply(e,["OAC.Client.StreamingVideo.Controller.KeyboardListener"].concat(b.call(c),[function(b){var c;c=b.options;return b.applyBindings=function(b,d){var e;e=b.locate("doc"),c.application.events.onActiveAnnotationChange.addListener(function(a){var b;return b=a});return a(e).keydown(function(a){var d,e;if(c.application.getCurrentMode()!=="Editing"&&typeof d!="undefined"&&d!==null)if((e=a.keyCode)===8||e===46){b.events.onDelete.fire(d);return d=null}})}}]))}}),c.namespace("Drag",function(a){return a.initController=function(){var a,c;a=1<=arguments.length?b.call(arguments,0):[];return(c=d.Controller).initController.apply(c,["OAC.Client.StreamingVideo.Controller.Drag"].concat(b.call(a),[function(a){return a.applyBindings=function(a,b){var c,d,e,f;f=a.locate("raphael"),e=function(b,c,d){b=d.layerX,c=d.layerY;return a.events.onFocus.fire(b,c)},c=function(){return a.events.onUnfocus.fire()},d=function(b,c){return a.events.onUpdate.fire(b,c)};return f.drag(d,e,c)}}]))}}),c.namespace("Select",function(a){return a.initController=function(){var a,c;a=1<=arguments.length?b.call(arguments,0):[];return(c=d.Controller).initController.apply(c,["OAC.Client.StreamingVideo.Controller.Select"].concat(b.call(a),[function(a){var b;b=a.options;return a.applyBindings=function(a){var c;c=a.locate("raphael");return c.click(function(c){if(b.isSelectable())return a.events.onSelect.fire()})}}]))}}),c.namespace("AnnotationEditSelectionGrid",function(c){return c.initController=function(){var c,f;c=1<=arguments.length?b.call(arguments,0):[];return(f=d.Controller).initController.apply(f,["OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid"].concat(b.call(c),[function(b){var c,d,f;f=b.options,c=b.options.dirs,d=e.Client.StreamingVideo.Controller.Drag.initController({});return b.applyBindings=function(e,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;u={},A={},E={},x={},v={},l={},p={},z={},q={},C=g.paper,h={},B=5,t={},m,r={},D={},y={},k={},o={},s={},e.attachRendering=function(a){var b;e.detachRendering();if(a!=null){b=a,i();return m()}},e.detachRendering=function(){var b;if(!a.isEmptyObject(u)){b=void 0,u.hide(),E.hide(),A.hide();if(x)return x.hide()}},i=function(){var a;a=activeRendering.getExtents(),h.width=a.width+2*B,h.height=a.height+2*B,h.x=a.x-B/8-h.width/2,h.y=a.y-B/8-h.height/2,j(h);if(x)return n(h)},m=function(){var b,c,g,k;if(a.isEmptyObject(u)){u=C.set();for(c in v)k=v[c],c==="mid"?(A=C.rect(k.x,k.y,B,B),k.id=A.id):(b=C.rect(k.x,k.y,B,B),k.id=b.id,b.attr({cursor:k.cursor}),u.push(b));u.attr({fill:99e4,stroke:"black"}),a.isEmptyObject(A)||A.attr({fill:99e4,stroke:"black",cursor:"move"}),E=C.rect(h.x,h.y,h.width,h.height),E.attr({stroke:"green","stroke-dasharray":["--"]}),n(h),a.isEmptyObject(A)||(g=d.bind(A),g.events.onUpdate.addListener(function(a,b){r.nx=h.x+a,r.ny=h.y+b,D.x=extents.x+a,D.y=extents.y+b,E.attr({x:r.nx,y:r.ny}),j({x:r.nx,y:r.ny,width:h.width,height:h.height});if(x)return n({x:r.nx,y:r.ny,width:h.width,height:h.height})}),g.events.onFocus.addListener(function(a,b){var c,d;c=a,d=b,i();return activeRendering.shape.attr({cursor:"move"})}),g.events.onUnfocus.addListener(function(){return e.events.onMove.fire({x:D.x,y:D.y})}));return u.forEach(function(a){var b;b=d.bind(a),b.events.onUpdate.addListener(function(a,b){D.w=Math.abs(extents.width+a*q.x),D.h=Math.abs(extents.height+b*q.y),r.nw=D.w+B*2,r.nh=D.h+B*2,r.nx=extents.x-B/4-r.nw/2,r.ny=extents.y-B/4-r.nh/2,E.attr({x:r.nx,y:r.ny,width:r.nw,height:r.nh}),j({x:r.nx,y:r.ny,width:r.nw,height:r.nh});if(x)return n({x:r.nx,y:r.ny,width:r.nw,height:r.nh})}),b.events.onFocus.addListener(function(a,b){var c,d,e,g,h;c=activeRendering.getExtents(),d=a,e=b,f.application.setCurrentMode("Drag"),g=8*(d-c.x)/c.width+4,h=8*(e-c.y)/c.height+4,g<3?q.x=-2:g<5?q.x=0:q.x=2,h<3?q.y=-2:h<5?q.y=0:q.y=2;return i()});return b.events.onUnfocus.addListener(function(){typeof activeRendering!="undefined"&&activeRendering!==null&&e.events.onResize.fire({width:D.w,height:D.h});return f.application.setCurrentMode("Select")})})}E.show(),E.attr({x:h.x,y:h.y,width:h.width,height:h.height}),u.show(),A.show().toFront();if(x){x.show();return n(h)}},n=function(c){if(a.isEmptyObject(x)){y.x=c.x+c.width,y.y=c.y-B*4-2,y.w=100,y.h=20,o={x:y.x+2,y:y.y+2,w:y.w/2-4,h:y.h-y.h/8},k={x:o.x+o.w+2,y:y.y+2,w:y.w/2-4,h:y.h-y.h/8},x=C.set(),z=C.rect(y.x,y.y,y.w,y.h),z.attr({fill:"#FFFFFF",stroke:"#000"}),x.push(z),p=C.rect(o.x,o.y,o.w,o.h),p.attr({fill:334009,cursor:"pointer"}),x.push(p),l=C.rect(k.x,k.y,k.w,k.h),l.attr({fill:334009,cursor:"pointer"}),x.push(l),p.mousedown(function(){if(typeof activeRendering!="undefined"&&activeRendering!==null)return b.events.onEdit.fire(activeRendering.id)}),p.hover(function(){return p.attr({fill:443009})},function(){return p.attr({fill:334009})}),l.mousedown(function(){if(typeof activeRendering!="undefined"&&activeRendering!==null){e.events.onDelete.fire();return w()}});return l.hover(function(){return l.attr({fill:443009})},function(){return l.attr({fill:334009})})}y.x=c.x+c.width,y.y=c.y-B*4-2,o={x:y.x+2,y:y.y+2},k={x:o.x+p.attr("width")+2,y:y.y+2},z.attr({x:y.x,y:y.y}),p.attr(o);return l.attr(k)},w=function(){var a;e.detachRendering(),a=void 0,x.hide(),E.hide(),u.hide();return A.hide()},s={ul:["nw",0,0,0,0],top:["n",1,0,0,0],ur:["ne",2,-1,0,0],rgt:["e",2,-1,1,0],lr:["se",2,-1,2,-1],btm:["s",1,0,2,-1],ll:["sw",0,0,2,-1],lft:["w",0,0,1,0],mid:["pointer",1,0,1,0]};return j=function(a){var b,d,e,f,g,h,i;b=function(b,c,d,e,f){return{x:a.x+c*a.width/2+d*B,y:a.y+e*a.height/2+f*B,cursor:b.length>2?b:b+"-resize"}},f=function(b,c,d,e,f){var g;b.x=a.x+c*a.width/2+d*B,b.y=a.y+e*a.height/2+f*B,g=C.getById(b.id);return g.attr({x:b.x,y:b.y})},i=[];for(g=0,h=c.length;g<h;g++)e=c[g],d=s[e],d!=null?v[e]!=null?i.push(f(v[e],d[1],d[2],d[3],d[4])):i.push(v[e]=b(d[0],d[1],d[2],d[3],d[4])):i.push(void 0);return i}}}]))}}),c.namespace("ShapeCreateBox",function(c){return c.initController=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initController.apply(e,["OAC.Client.StreamingVideo.Controller.ShapeCreateBox"].concat(b.call(c),[function(b){var c;c=b.options;return b.applyBindings=function(b,c){var d,e,f,g,h,i;i={},e={},g=c.paper,d={},f=10,h={},b.createGuide=function(b){d.x=b[0],d.y=b[1],d.width=b[0]+f,d.height=b[1]+f;if(a.isEmptyObject(i)){i=g.rect(d.x,d.y,d.width,d.height);return i.attr({stroke:"green","stroke-dasharray":["--"]})}i.show();return i.attr({x:d.x,y:d.y,width:d.width,height:d.height})},b.resizeGuide=function(a){d.width=a[0]-d.x,d.height=a[1]-d.y;return i.attr({width:d.width,height:d.height})};return b.completeShape=function(a){d.width=a.width,d.height=a.height,i.attr({width:d.width,height:d.height}),i.hide();return{x:d.x,y:d.y,width:d.width,height:d.height}}}}]))}}),c.namespace("TextBodyEditor",function(c){return c.initController=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initController.apply(e,["OAC.Client.StreamingVideo.Controller.TextBodyEditor"].concat(b.call(c),[function(b){var c;c=b.options;return b.applyBindings=function(b,d){var e,f,g,h,i,j,k,l,m,n,o,p;f=b.locate("annotation"),h=b.locate("body"),e=b.locate("annotations"),o=b.locate("textarea"),j=b.locate("editarea"),k=b.locate("editbutton"),p=b.locate("updatebutton"),i=b.locate("deletebutton"),g=!1,m=function(){a(j).show(),a(h).hide(),g=!0;return b.events.onClick.fire(d.itemId)},l=function(){a(j).hide(),a(h).show();return g=!1},n=function(c){var e;e=a(o).val(),c.preventDefault(),b.events.onUpdate.fire(d.itemId,e);return l()},a(f).bind("dblclick",function(a){var b;a.preventDefault();if(g){l();return c.application.setCurrentMode(b||"")}m(),b=c.application.getCurrentMode();return c.application.setCurrentMode("TextEdit")}),a(f).bind("click",function(a){return c.application.setActiveAnnotation(d.itemId)}),a(p).bind("click",function(e){b.events.onUpdate.fire(d.itemId,a(o).val()),l();return c.application.setCurrentMode(prevMode)}),a(i).bind("click",function(c){b.events.onDelete.fire(d.itemId);return a(f).remove()}),c.application.events.onActiveAnnotationChange.addListener(function(a){if(a!==d.id&&g){n({preventDefault:function(){}});return l()}});return c.application.events.onCurrentModeChange.addListener(function(a){if(a!=="TextEdit")return l()})}}]))}}),c.namespace("CanvasClickController",function(c){return c.initController=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initController.apply(e,["OAC.Client.StreamingVideo.Controller.CanvasClickController"].concat(b.call(c),[function(b){var c;c=b.options;return b.applyBindings=function(b,d){var e,f,g,h,i,j,k;f=d.closeEnough,j={},i=d.paper,e=function(a){var c,d;if(typeof c=="undefined"||c===null||a!==c.id){d=j[a];if(d!=null)return c=d;b.events.onClick.fire(void 0);return c=void 0}},g=function(a){var b;if(typeof curRendering=="undefined"||curRendering===null||a!==curRendering.id)return b=j[a]},h=function(c){var d,e,f,g;e=0,g=[],d=[],f=a(c).offset(),a(c).unbind(),a(c).mousedown(function(a){var c,d;if(e<=0){c=a.pageX-f.left,d=a.pageY-f.top,g=[c,d],e=1;return b.events.onShapeStart.fire(g)}}),a(c).mousemove(function(a){var c,g;if(e!==2&&e!==0){c=a.pageX-f.left,g=a.pageY-f.top,d=[c,g];return b.events.onShapeDrag.fire(d)}});return a(c).mouseup(function(a){if(e>=1){e=0,d==null&&(d=[x+5,y+5]);return b.events.onShapeDone.fire({x:g[0],y:g[1],width:d[0]-g[0],height:d[1]-g[1]})}})},k=function(b){a(b).unbind();return a(b).bind("mousedown",function(a){var b;c.application.setActiveAnnotation(void 0);return b=null})},c.application.events.onActiveAnnotationChange.addListener(e),c.application.events.onCurrentModeChange.addListener(function(c){return c==="Rectangle"||c==="Ellipse"?h(b.locate("svgwrapper")):c==="Select"?k(b.locate("svgwrapper")):a(b.locate("svgwrapper")).unbind()}),b.registerRendering=function(a){return j[a.id]=a};return b.removeRendering=function(a){return delete j[a.id]}}}]))}}),c.namespace("AnnotationCreationButton",function(c){return c.initController=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initController.apply(e,["OAC.Client.StreamingVideo.Controller.AnnotationCreationButton"].concat(b.call(c),[function(b){var c;c=b.options;return b.applyBindings=function(b,d){var e,f,g;e=!1,f=b.locate("button"),a(f).live("mousedown",function(b){if(e===!1){e=!0,c.application.setCurrentMode(d.action);return a(f).addClass("active")}if(e===!0){e=!1,c.application.setCurrentMode("");return a(f).removeClass("active")}}),g=function(b){if(b===c.action){e=!0;return a(f).addClass("active")}e=!1;return a(f).removeClass("active")};return c.application.events.onCurrentModeChange.addListener(g)}}]))}}),c.namespace("sliderButton",function(c){return c.initController=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initController.apply(e,["OAC.Client.StreamingVideo.Controller.sliderButton"].concat(b.call(c),[function(b){var c;c=b.options;return b.applyBindings=function(b,d){var e,f,g,h,i;e=b.locate("timedisplay"),f=function(b){var c;if(typeof c=="undefined"||c===null){c=b;return a(g).slider("value",c)}},i=function(b,d){var f;c.application.setCurrentTime(d.value),a(e).text("TIME: "+d.value);return f=d.value},h=function(b,d){var f;d==null&&(f=b,a(g).slider("value",b));if(f!==d.value){c.application.setCurrentTime(d.value),a(e).text("TIME: "+d.value);return f=d.value}},g=b.locate("slider");return a(g).slider({start:i,slide:h})}}]))}}),c.namespace("timeControl",function(c){return c.initController=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Controller).initController.apply(e,["OAC.Client.StreamingVideo.Controller.timeControl"].concat(b.call(c),[function(b){var c;c=b.options,b.currentId="";return b.applyBindings=function(b,d){var e,f,g,h;h=b.locate("timestart"),g=b.locate("timeend"),f=b.locate("submit"),e=b.locate("menudiv"),a(e).hide(),a(f).bind("click",function(){var c,d;d=parseInt(a(h).val(),10),c=parseInt(a(g).val(),10);if(b.currentId!=null&&d!=null&&c!=null){b.events.onUpdate.fire(b.currentId,d,c);return a(e).hide()}});return c.application.events.onActiveAnnotationChange.addListener(function(c){if(c!=null){a(e).show(),a(h).val(""),a(g).val("");return b.currentId=c}return a(e).hide()})}}]))}});return c.namespace("WindowResize",function(a){return a.initController=function(){var a,c;a=1<=arguments.length?b.call(arguments,0):[];return(c=d.Controller).initController.apply(c,["OAC.Client.StreamingVideo.Controller.WindowResize"].concat(b.call(a),[function(a){var b;b=a.options;return a.applyBindings=function(a,b){var c;c=a.locate("resizeBox");return c.resize(function(){return setTimeout(a.events.onResize.fire,0)})}}]))}})}),d.Presentation.namespace("AnnotationList",function(a){return a.initPresentation=function(){var a,c;a=1<=arguments.length?b.call(arguments,0):[];return(c=d.Presentation).initPresentation.apply(c,["MITHGrid.Presentation.AnnotationList"].concat(b.call(a),[function(a,b){}]))}}),d.Presentation.namespace("RaphaelCanvas",function(c){return c.initPresentation=function(){var c,e;c=1<=arguments.length?b.call(arguments,0):[];return(e=d.Presentation).initPresentation.apply(e,["MITHGrid.Presentation.RaphaelCanvas"].concat(b.call(c),[function(b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v;j=a(c).attr("id"),m=b.options,e=m.controllers.canvas,k=m.controllers.keyboard,h=m.controllers.shapeEditBox,o=m.controllers.shapeCreateBox,t=m.controllers.windowResize,u=a(c).css("x"),v=a(c).css("y"),r=a(c).width(),i=a(c).height(),l=k.bind(a(c),{}),b.events=a.extend(!0,b.events,l.events),b.canvas=new Raphael(a(c),r,i),d=e.bind(a(c),{closeEnough:5,paper:b.canvas}),g=h.bind(a(c),{paper:b.canvas}),n=o.bind(a(c),{paper:b.canvas}),s=t.bind(window),g.events.onResize.addListener(function(a){var c;c=b.getActiveRendering();if(c!=null&&c.eventResize!=null)return c.eventResize(a)}),g.events.onMove.addListener(function(a){var c;c=b.getActiveRendering();if(c!=null&&c.eventMove!=null)return c.eventMove(a)}),g.events.onDelete.addListener(function(){var a;a=b.getActiveRendering();if(a!=null&&a.eventDelete!=null){a.eventDelete();return g.detachRendering()}}),m.application.events.onCurrentModeChange.addListener(function(a){if(a!=="Select"&&a!=="Drag")return g.detachRendering()}),s.events.onResize.addListener(function(){var b,d,e;b=a("body").find("svg"),d=a(m.playerWrapper),e=a(c),u=parseInt(a(d).offset().left,10),v=parseInt(a(d).offset().top,10),r=parseInt(a(d).width(),10),i=parseInt(a(d).height(),10),a(b).css({left:u+"px",top:v+"px",width:r+"px",height:i+"px"});return a(e).css({left:u+"px",top:v+"px",width:r+"px",height:i+"px"})}),s.events.onResize.fire(),d.events.onShapeStart.addListener(function(a){return n.createGuide(a)}),d.events.onShapeDrag.addListener(function(a){return n.resizeGuide(a)}),d.events.onShapeDone.addListener(function(a){var b;b=n.completeShape(a);return m.application.insertShape(b)}),f=function(b){var d,e;if(b!=null){e=b.getcoordinates(),d=b.getsize(),a(c).css({left:parseInt(e[0],10)+"px",top:parseInt(e[1],10)+"px",width:d[0],height:d[1]});return a("svg").css({left:parseInt(e[0],10)+"px",top:parseInt(e[1],10)+"px",width:d[0],height:d[1]})}},m.application.events.onCurrentTimeChange.addListener(function(a){return b.visitRenderings(function(b,c){if(c.eventCurrentTimeChange!=null)return c.eventCurrentTimeChange(a)})}),m.application.events.onTimeEasementChange.addListener(function(a){return b.visitRenderings(function(b,c){if(c.eventTimeEasementChange!=null)return c.eventTimeEasementChange(a)})}),m.application.events.onPlayerChange.addListener(f),m.application.dataStore.canvas.events.onModelChange.addListener(function(){return g.detachRendering()}),q=b.render,b.render=function(a,b,c){var e,f,g,h;f=q(a,b,c);if(f!=null){h=b;while(h.dataStore)h=h.dataStore;e=h,g=m.dataView.prepare(["!type"]),d.registerRendering(f)}return f},p=b.eventFocusChange;return b.eventFocusChange=function(a){if(m.application.getCurrentMode()==="Select"){p(a);return g.attachRendering(b.getActiveRendering())}}}]))}}),f=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},h=function(){return f()+f()+"-"+f()+"-"+f()+"-"+f()+"-"+f()+f()+f()},g=1;return e.Client.StreamingVideo.initApp=e.Client.StreamingVideo.initInstance=function(){var e,f,i,j,k,l,m,n,o,p,q,r;e=1<=arguments.length?b.call(arguments,0):[],o={},n=0,l="OAC-Client-StreamingVideo-SVG-Canvas-"+g,q=[],p=[],r=d.normalizeArgs.apply(d,["OAC.Client.StreamingVideo"].concat(b.call(e))),k=r[0],i=r[1],m=r[2],f=r[3],g+=1,j=a.extend(!0,{},{viewSetup:'<div id="'+l+'" class="section-canvas"></div>\n<div class="mithgrid-bottomarea">\n\t<div class="timeselect">\n\t\t<p>Enter start time:</p>\n\t\t<input id="timestart" type="text" />\n\t\t<p>Enter end time:</p>\n\t\t<input id="timeend" type="text" />\n\t\t<div id="submittime" class="button">Confirm time settings</div>\n\t</div>\n\t<div id="sidebar'+l+'" class="section-controls"></div>\n\t<div class="section-annotations">\n\t\t<div class="header">\n\t\t\tAnnotations\n\t\t</div>\n\t</div>\n</div>',controllers:{keyboard:{isActive:function(){return app.getCurrentMode()!=="Editing"}},selectShape:{isSelectable:function(){return app.getCurrentMode()==="Select"}}},presentations:{raphsvg:{container:"#"+l,lenses:{},lensKey:[".shapeType"],playerWrapper:m.playerWrapper},annoItem:{container:".section-annotations",lenses:{},lensKey:[".bodyType"]}}},m);return d.Application.initInstance(k,i,j,function(b){var d,e,f;f=b,f.initShapeLens=function(a,b,c,d){var e,g,h,i,j,k,l,m;m={id:d},j=c.getItem(d),e=function(a){var b;b=0;if(a<i||a>h)return 0;a<l?(b=1/(l-a),b=b.toFixed(3)):a>g?(b=1/(a-g),b=b.toFixed(3)):b=1;return b},l=j.npt_start[0],g=j.npt_end[0],i=l-f.getTimeEasement(),h=g+f.getTimeEasement(),k=e(f.getCurrentTime()),m.eventTimeEasementChange=function(a){i=l-a,h=g+a;return m.setOpacity(e(f.getCurrentTime()))},m.eventCurrentTimeChange=function(a){return m.setOpacity(e(a))},m.setOpacity=function(a){a!=null&&(k=a);return m.shape.attr({opacity:(typeof focused!="undefined"&&focused!==null?focused:{1:.5})*k})},m.eventFocus=function(){var a;a=1,m.setOpacity(),m.shape.toFront();return b.events.onDelete.addListener(m.eventDelete)},m.eventUnfocus=function(){var a;a=0,m.setOpacity(),m.shape.toBack();return b.events.onDelete.removeListener(m.eventDelete)},m.eventDelete=function(){return c.removeItems([d])},m.eventResize=function(a){return c.updateItems([{id:d,w:a.width,h:a.height}])},m.eventMove=function(a){return c.updateItems([{id:d,x:a.x,y:a.y}])},m.update=function(a){if(a.npt_start[0]!==l||a.npt_end[0]!==g){l=a.npt_start[0],g=a.npt_end[0],i=l-f.getTimeEasement(),h=g+f.getTimeEasement();return m.setOpacity(e(f.getCurrentTime()))}},m.remove=function(a){return m.shape.remove()};return m},f.initTextLens=function(b,c,d,e){var g,h,i,j,k,l;l={},j=d.getItem(e),k=a('<div class="anno_item">\n\t<p class="bodyContentInstructions">Double click here to open edit window.</p>\n\t<div class="editArea">\n\t\t<textarea class="bodyContentTextArea"></textarea>\n\t\t<div id="editUpdate" class="button update">Update</div>\n\t\t<div id="editDelete" class="button delete">Delete</div>\n\t</div>\n\t<div class="body">\n\t\t<p class="bodyContent"></p>\n\t</div>\n</div>'),i=a(k).find(".bodyContentTextArea"),h=a(k).find(".bodyContent"),a(i).text(j.bodyContent[0]),a(h).text(j.bodyContent[0]),a(b).append(k),a(k).find(".editArea").hide(),l.eventFocus=function(){return k.addClass("selected")},l.eventUnfocus=function(){return k.removeClass("selected")},l.eventUpdate=function(a,b){if(a===e)return d.updateItems([{id:e,bodyContent:b}])},l.eventDelete=function(a){if(a===e)return d.removeItems([e])},l.update=function(b){a(k).find(".bodyContent").text(b.bodyContent[0]);return a(k).find(".bodyContentTextArea").text(b.bodyContent[0])},l.remove=function(){return a(k).remove()},g=f.controller.annoActive.bind(k,{model:d,itemId:e}),g.events.onClick.addListener(f.setActiveAnnotation),g.events.onDelete.addListener(l.eventDelete),g.events.onUpdate.addListener(l.eventUpdate);return l},f.buttonFeature=function(b,c,d){var e,g,h,j,k;if(a("#"+d+l).length!==0)return!1;k={},g=a(".button"),i=a("#sidebar"+l);switch(b){case"buttongrouping":a(i).find("#"+c+l).length===0&&a(i).append('<div id="'+c+l+'" class="buttongrouping"></div>'),h=a("#"+c+l),j='<div id="'+d+l+'" class="button">'+d+"</div>",a(h).append(j),k.element=a("#"+d+l),e=f.controller.buttonActive.bind(k.element,{action:d});break;case"slidergrouping":a(i).find("#"+c+l).length===0&&a(i).append('<div id="'+c+l+'" class="slidergrouping"></div>'),h=a("#"+c+l),j='<div id="'+d+l+'"><div class="header">'+d+l+"</div>"+'<div id="slider"></div><div class="timedisplay"></div></div>',a(h).append(j),k.element=a("#"+d+l),e=f.controller.slider.bind(k.element,{action:d})}return k},f.addShape=function(a,b){return f.presentation.raphsvg.addLens(a,b)},f.addBody=function(a,b){return f.presentation.annoItem.addLens(a,b)},f.addShapeType=function(a,b){var c,d,e;d=b.calc,e=b.lens,c=f.buttonFeature("Shapes",a),o[a]={calc:d};return f.addShape(a,e)},f.insertShape=function(b){var c,d,e,g,i;e=parseFloat(f.getCurrentTime())-5,d=parseFloat(f.getCurrentTime())+5,c=f.getCurrentMode();if(o[c]!=null){g=o[c].calc(b),n=h(),i={id:"anno"+n,type:"Annotation",bodyType:"Text",bodyContent:"This is an annotation for "+c,shapeType:c,targetURI:f.options.url,npt_start:e<0?0:e,npt_end:d};return f.dataStore.canvas.loadItems([a.extend(!0,i,g)])}},e={root:"http:#www.openannotation.org/ns/",Annotation:"http:#www.openannotation.org/ns/Annotation",Body:"http:#www.openannotation.org/ns/Body",Target:"http:#www.openannotation.org/ns/Target",SpTarget:"http:#www.openannotation.org/ns/ConstrainedTarget",Selector:"http:#www.w3.org/ns/openannotation/core/CompoundSelector",FragSelector:"http:#www.w3.org/ns/openannotation/core/FragmentSelector",SVGConstraint:"http:#www.w3.org/ns/openannotation/extensions/SvgSelector"},d={OA:"http://www.w3.org/ns/openannotation/core",OAX:"http://www.w3.org/ns/openannotation/extensions",RDF:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",CNT:"http://www.w3.org/2008/content#",DC:"http://purl.org/dc/elements/1.1/"},f.importData=function(b){var e,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B;q=[];for(k=0,u=b.length;k<u;k++){h=b[k];if(x=d.OA+"Annotation",c.call(k[d.RDF+"type"],x)>=0)if(k[d.OA+"hasTarget"]!=null){y=k[d.OA+"hasTarget"];for(s=0,v=y.length;s<v;s++){g=y[s];if(b[g.value]!=null&&b[g.value][d.OA+"hasSource"]!=null)if(z=f.options.url,c.call(function(){var a,c,e,f;e=b[g.value][d.OA+"hasSource"],f=[];for(a=0,c=e.length;a<c;a++)l=e[a],f.push(l.value);return f}(),z)>=0){p={id:h,type:"Annotation",bodyContent:"",bodyType:"Text",targetURI:f.options.url,shapeType:"",npt_start:0,npt_end:0},r=b[g.value],A=r[d.OA+"hasSelector"];for(t=0,w=A.length;t<w;t++)e=A[t],b[e.value]!=null&&(B=d.OAX+"CompoundSelector",c.call(function(){var a,c,f,g;f=b[e.value][d.RDF+"type"],g=[];for(a=0,c=f.length;a<c;a++)o=f[a],g.push(o.value);return g}(),B)>=0)&&(m=b[e.value],n=b[m.hasSelector[0].value],p.shapeType=a(n.chars[0].value)[0].nodeName,p.shapeType==="RECT"?p.shapeType="Rectangle":p.shapeType==="ELLI"&&(p.shapeType="Ellipse"),p.x=parseInt(a(n.chars[0].value).attr("x"),10),p.y=parseInt(a(n.chars[0].value).attr("y"),10),p.w=parseInt(a(n.chars[0].value).attr("width"),10),p.h=parseInt(a(n.chars[0].value).attr("height"),10),j=b[m.hasSelector[1].value],i=j.value[0].value.replace(/^t=npt:/g,""),p.npt_start=parseInt(i.replace(/\,[0-9]+/g,""),10),p.npt_end=parseInt(i.replace(/^[0-9]+\,/g,""),10),p.bodyContent=b[k.hasBody[0].value].chars[0].value||"",q.push(p))}}}else p={id:h,type:"Annotation",bodyContent:"",bodyType:"Text",targetURI:f.options.url,shapeType:"",npt_start:0,npt_end:0},k[d.OA+"hasBody"]!=null&&(p.bodyContent=b[k[d.OA+"hasBody"][0].value][d.CNT+"chars"][0]),q.push(p)}return f.dataStore.canvas.loadItems(q)},f.exportData=function(a){var b,c,g,i,j,k,l,m,n,o,p,q,r,s;o={},g=f.dataStore.canvas.prepare(["!type"]),m=function(a,b,c,d,e){o[a]==null&&(o[a]={}),o[a][b+c]==null&&(o[a][b+c]=[]);return o[a][b+c].push({type:d,value:e})},b=function(a,b,c,d){return m(a,b,c,"bnode",d)},p=function(a,b,c,d){return m(a,b,c,"uri",d)},k=function(a,b,c,d){return m(a,b,c,"literal",d)},i=function(a,b){p(b,d.RDF,"type",""+d.OA+"Body"),k(b,d.DC,"format","text/plain"),k(b,d.CNT,"characterEncoding","utf-8");return k(b,d.CNT,"chars",a.bodyContent[0])},j=function(a,c){p(c[0],d.RDF,"type",""+d.OA+"ConstrainedTarget"),p(c[0],d.OA,"hasSource",a.targetURI[0]),b(c[0],d.OA,"hasSelector",c[1]),p(c[1],d.RDF,"type",""+d.OA+"CompoundSelector"),b(c[1],d.OA,"hasSelector",c[2]),b(c[1],d.OA,"hasSelector",c[3]),p(c[2],d.RDF,"type",""+d.OAX+"SVGConstraint"),k(c[2],d.DC,"format","text/svg+xml"),k(c[2],d.CNT,"characterEncoding","utf-8"),k(c[2],d.CNT,"chars","<"+a.shapeType[0].substring(0,4).toLowerCase()+' x="'+a.x[0]+'" y="'+a.y[0]+'" width="'+a.w[0]+'" height="'+a.h[0]+'" />'),p(c[3],d.RDF,"type",""+d.OA+"FragSelector");return k(c[3],d.RDF,"value","t=npt:"+a.npt_start[0]+","+a.npt_end[0])},c=function(a){var c,e,g,k,l,m;g=f.dataStore.canvas.getItem(a[0]),a.length>1?(c=a[1],m=a[2],k=a[3],l=a[4],e=a[5]):(c="_:b"+h(),m="_:t"+h(),k="_:sel"+h(),l="_:sel"+h(),e="_:sel"+h()),p(a[0],d.RDF,"type",""+d.OA+"Annotation"),b(a[0],d.OA,"hasBody",c),b(a[0],d.OA,"hasTarget",m),i(g,c);return j(g,[m,k,l,e])},l=function(b){var g,h,i,k,l,m,n,o,p,q,r,s,t,u;i=f.dataStore.canvas.getItem(b);if(a[i.id]!=null){s=a[i.id],u=[];for(q in s){r=s[q];switch(q){case""+d.OA+"hasBody":g=a[i.id].hasBody[0].value,u.push(a[g].chars[0].value=i.bodyContent);break;case""+d.OA+"hasTarget":if(i.targetURI[0]!=null&&i.x[0]!=null){p=a[i.id].hasTarget[0].value,h=!1;if(a[p].hasSource[0].value===i.targetURI[0]){o=a[p].hasSelector[0].value,h=!0,t=a[o];for(m in t){n=t[m];if(m==="hasSelector")for(k in n)l=n[k],a[l.value].type[0].value===e.SVGConstraint?a[l.value].chars=[{type:"literal",value:"<"+i.shapeType[0].substring(0,4).toLowerCase()+' x="'+i.x[0]+'" y="'+i.y[0]+' width="'+i.w[0]+'" height="'+i.h[0]+'" />'}]:a[l.value].type[0].value===e.FragSelector&&(a[n].chars=[{type:"literal",value:"t=npt:"+i.npt_start[0]+","+i.npt_end[0]}])}}h?u.push(void 0):u.push(j(i))}else u.push(void 0)}}return u}return c(i.id)},a=a||{},s=g.evaluate("Annotation");for(q=0,r=s.length;q<r;q++)n=s[q],l(n);return o},f.ready(function(){f.events.onActiveAnnotationChange.addListener(f.presentation.raphsvg.eventFocusChange),f.events.onActiveAnnotationChange.addListener(f.presentation.annoItem.eventFocusChange),f.events.onCurrentTimeChange.addListener(function(a){f.dataView.currentAnnotations.setKeyRange(a-5,a+5);return f.setCurrentMode("Watch")});return f.events.onPlayerChange.addListener(function(a){f.setCurrentTime(a.getPlayhead()),a.onPlayheadUpdate(function(a){return f.setCurrentTime(f.getCurrentTime()+1)});return f.events.onCurrentModeChange.addListener(function(b){if(b!=="Watch")return a.pause();if(b==="Watch")return a.play()})})});return f.ready(function(){var b,c,d,e,g,h;c=function(b,c,d){var e;e=a.extend(!0,{},b),e.x=e.x/c*100,e.y=e.y/d*100,e.w=e.w/c*100,e.h=e.h/d*100;return e},f.addShapeType("Rectangle",{calc:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2,w:a.width,h:a.height}},lens:function(b,c,d,e){var g,h,i,j,k;k=f.initShapeLens(b,c,d,e),h=d.getItem(e),g=c.canvas.rect(h.x[0]-h.w[0]/2,h.y[0]-h.h[0]/2,h.w[0],h.h[0]),k.shape=g,g.attr({fill:"red"}),k.setOpacity(),a(g.node).attr("id",h.id[0]),i=f.controller.selectShape.bind(g),i.events.onSelect.addListener(function(){return f.setActiveAnnotation(e)}),j=k.update,k.update=function(a){h=a,j(h);if(h.x!=null&&h.y!=null&&h.w!=null&&h.h!=null)return g.attr({x:h.x[0]-h.w[0]/2,y:h.y[0]-h.h[0]/2,width:h.w[0],height:h.h[0]})},k.getExtents=function(){return{x:g.attr("x")+g.attr("width")/2,y:g.attr("y")+g.attr("height")/2,width:g.attr("width"),height:g.attr("height")}};return k}}),f.addShapeType("Ellipse",{calc:function(a){return{x:a.x+a.width/2,y:a.y+a.height/2,w:a.width,h:a.height}},lens:function(a,b,c,d){var e,g,h,i,j;j=f.initShapeLens(a,b,c,d),g=c.getItem(d),e=b.canvas.ellipse(g.x[0],g.y[0],g.w[0]/2,g.h[0]/2),j.shape=e,e.attr({fill:"red"}),j.setOpacity(),h=f.controller.selectShape.bind(e),h.events.onSelect.addListener(function(){return f.setActiveAnnotation(d)}),i=j.update,j.update=function(a){i(a);if(a.x!=null&&a.y!=null)return e.attr({cx:a.x[0],cy:a.y[0],rx:a.w[0]/2,ry:a.h[0]/2})},j.getExtents=function(){return{x:e.attr("cx"),y:e.attr("cy"),width:e.attr("rx")*2,height:e.attr("ry")*2}};return j}}),f.addBody("Text",f.initTextLens),d=f.buttonFeature("buttongrouping","Shapes","Rectangle"),b=f.buttonFeature("buttongrouping","Shapes","Ellipse"),e=f.buttonFeature("buttongrouping","General","Select"),h=f.buttonFeature("buttongrouping","General","Watch"),f.setCurrentTime(0),g=f.controller.timecontrol.bind(".timeselect",{});return g.events.onUpdate.addListener(function(a,b,c){return f.dataStore.canvas.updateItems([{id:a,npt_start:b,npt_end:c}])})})})}}(jQuery,MITHGrid,a),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.CanvasClickController",{bind:{events:{onClick:null,onShapeStart:null,onShapeDrag:null,onShapeDone:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.TextBodyEditor",{bind:{events:{onClick:null,onDelete:null,onUpdate:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid",{dirs:["ul","top","ur","lft","lr","btm","ll","rgt","mid"],bind:{events:{onResize:null,onMove:null,onEdit:null,onDelete:null,onCurrentModeChange:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.KeyboardListener",{bind:{events:{onDelete:["preventable","unicast"]}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.AnnotationCreationButton",{bind:{events:{onCurrentModeChange:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.ShapeCreateBox",{bind:{events:{}}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.WindowResize",{bind:{events:{onResize:null}},selectors:{"":""}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.Drag",{bind:{events:{onFocus:null,onUnfocus:null,onUpdate:null}},selectors:{"":""}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.Select",{bind:{events:{onSelect:null}},selectors:{"":""},isSelectable:function(){return!0}}),MITHGrid.defaults("OAC.Client.StreamingVideo.Controller.timeControl",{bind:{events:{onUpdate:null}}}),MITHGrid.defaults("OAC.Client.StreamingVideo",{controllers:{keyboard:{type:a.Client.StreamingVideo.Controller.KeyboardListener,selectors:{doc:""}},shapeEditBox:{type:a.Client.StreamingVideo.Controller.AnnotationEditSelectionGrid},shapeCreateBox:{type:a.Client.StreamingVideo.Controller.ShapeCreateBox},canvas:{type:a.Client.StreamingVideo.Controller.CanvasClickController,selectors:{svgwrapper:""}},annoActive:{type:a.Client.StreamingVideo.Controller.TextBodyEditor,selectors:{annotation:"",annotationlist:":parent",bodycontent:".bodyContent",body:".body",editbutton:".button.edit",editarea:".editArea",textarea:".editArea > textarea",updatebutton:".button.update",deletebutton:".button.delete"}},buttonActive:{type:a.Client.StreamingVideo.Controller.AnnotationCreationButton,selectors:{button:""}},timecontrol:{type:a.Client.StreamingVideo.Controller.timeControl,selectors:{timestart:"#timestart",timeend:"#timeend",submit:"#submittime",menudiv:""}},selectShape:{type:a.Client.StreamingVideo.Controller.Select,selectors:{raphael:""}},windowResize:{type:a.Client.StreamingVideo.Controller.WindowResize,selectors:{resizeBox:""}}},
variables:{ActiveAnnotation:{is:"rw"},CurrentTime:{is:"rw","default":0},TimeEasement:{is:"rw","default":5},CurrentMode:{is:"rw"},Player:{is:"rw"}},dataViews:{currentAnnotations:{dataStore:"canvas",type:MITHGrid.Data.RangePager,leftExpressions:[".npt_start"],rightExpressions:[".npt_end"]}},dataStores:{canvas:{types:{Annotation:{}},properties:{shapeType:{valueType:"text"},bodyType:{valueType:"text"},bodyContent:{valueType:"text"},targetURI:{valueType:"uri"},npt_start:{valueType:"numeric"},npt_end:{valueType:"numeric"}}}},presentations:{raphsvg:{type:MITHGrid.Presentation.RaphaelCanvas,dataView:"currentAnnotations",controllers:{keyboard:"keyboard",canvas:"canvas",shapeCreateBox:"shapeCreateBox",shapeEditBox:"shapeEditBox",windowResize:"windowResize"},events:{onOpacityChange:null},fadeStart:5},annoItem:{type:MITHGrid.Presentation.AnnotationList,dataView:"currentAnnotations",container:".anno_list"}}})}).call(this);